<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer Helper</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:10px auto;padding:14px;}
  h1{margin:4px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:260px}
  textarea{width:100%;min-height:120px}
  .thumb{width:120px;height:90px;object-fit:contain;border:1px solid #ddd}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white}
  #collageCanvas{background:#fff;max-width:100%}
  #collagePreview{margin-top:8px;max-width:100%;border:1px solid #ccc;display:block}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fafafa}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px}
  .photo-preview{display:flex;gap:8px;align-items:center}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  .files-wrap{max-height:300px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px}
</style>
</head>
<body>
  <h1>Collage + Wayfarer Helper</h1>
  <div class="top-help">
    Flujo: 1) configura carpeta pública en Drive + API Key → 2) conectar → 3) seleccionar fotos → 4) generar collage → 5) guardar ubicaciones → 6) pegar propuestas que yo te entregue → 7) copiar campos.
  </div>

  <!-- Config -->
  <section>
    <h2>Configuración (reemplazar en el archivo)</h2>
    <p><b>IMPORTANTE:</b> en el código reemplaza <code>AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4</code> y <code>1SykigPCl4e003n6i2_PbopBrq22droo4</code> por tus valores.</p>
  </section>

  <hr/>

  <!-- 1. Conectar y listar carpeta de Drive -->
  <section>
    <h2>1) Listar fotos de la carpeta (Drive)</h2>
    <div class="controls-row">
      <button id="btnConnect" class="primary">Conectar y listar fotos</button>
      <button id="btnRefresh">Refrescar lista</button>
    </div>
    <div style="margin-top:8px" class="files-wrap" id="filesList"></div>
  </section>

  <hr/>

  <!-- 2. Seleccionar y generar collage -->
  <section>
    <h2>2) Selecciona fotos y genera collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span style="margin-left:12px" class="badge">Cols: <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span style="margin-left:8px" class="badge">Ancho por foto(px): <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage (PNG)</button>
      <button id="btnClearSelection">Limpiar selección</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
        <img id="collagePreview" />
      </div>
    </div>
  </section>

  <hr/>

  <!-- 3. Guardar ubicaciones (móvil) -->
  <section>
    <h2>3) Guardar ubicaciones (desde tu móvil)</h2>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicación</button>
      <button id="btnExportLocations">Exportar ubicaciones (JSON)</button>
      <button id="btnImportLocations">Importar ubicaciones</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <hr/>

  <!-- 4. Pegar propuestas -->
  <section>
    <h2>4) Pegar propuestas</h2>
    <textarea id="proposalsInput" placeholder="Pega aquí las propuestas..."></textarea>
    <div class="controls-row">
      <button id="btnParse" class="primary">Parsear y asociar</button>
      <button id="btnClearProposals">Limpiar</button>
    </div>
    <div id="proposalsList"></div>
  </section>

  <hr/>

  <!-- 5. Resultado final -->
  <section>
    <h2>5) Resultado final (foto + mapa + textos)</h2>
    <div id="finalList"></div>
  </section>

<script>
/* ========== REEMPLAZA ESTOS VALORES ========== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";       
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";   
/* ============================================= */

function driveDirectUrl(id){
  return `https://drive.google.com/uc?id=${id}`;
}

/* -----------------------
   Estado
----------------------- */
let files = []; 
let locations = []; 
let proposals = {}; 

/* -----------------------
   Listar archivos de Drive
----------------------- */
async function listarDrive(){
  const q = encodeURIComponent(`'${FOLDER_ID}' in parents and mimeType contains 'image/' and trashed=false`);
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&key=${API_KEY}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)&pageSize=300`;
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(json.error){ alert("Error Drive API: " + (json.error.message||JSON.stringify(json.error))); return; }
    files = (json.files||[]).map(f=>({
      id: f.id,
      name: f.name,
      url: driveDirectUrl(f.id),
      thumb: f.thumbnailLink || `https://drive.google.com/thumbnail?id=${f.id}&sz=w200`,
      selected:false
    }));
    renderFiles();
  }catch(err){
    alert("Error al listar Drive: "+err.message);
  }
}

document.getElementById('btnConnect').addEventListener('click', ()=>listarDrive());
document.getElementById('btnRefresh').addEventListener('click', ()=>listarDrive());

/* -----------------------
   Render archivos
----------------------- */
function renderFiles(){
  const wrap = document.getElementById('filesList');
  wrap.innerHTML = '';
  if(files.length===0){ wrap.innerHTML = '<small>No se encontraron imágenes.</small>'; return; }
  files.forEach((f,idx)=>{
    const div = document.createElement('div'); div.className='file-row';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!f.selected;
    cb.addEventListener('change', e=>{ f.selected = e.target.checked; updateSelectedCount(); });
    const img = document.createElement('img'); img.className='thumb'; img.src = f.thumb;
    img.onerror = ()=>{ img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="90"><rect width="100%" height="100%" fill="%23eee"/><text x="50%" y="50%" font-size="12" text-anchor="middle" fill="%23666" dy=".3em">No preview</text></svg>'};
    const span = document.createElement('div'); span.style.flex='1'; span.innerText = f.name;
    div.appendChild(cb); div.appendChild(img); div.appendChild(span);
    wrap.appendChild(div);
  });
  updateSelectedCount();
}

function updateSelectedCount(){
  const c = files.filter(f=>f.selected).length;
  document.getElementById('selectedCount').innerText = c;
}

/* -----------------------
   Ubicaciones: mapa ampliado
----------------------- */
function makeMapClickable(mapDiv, lat, lon){
  mapDiv.style.cursor = 'pointer';
  mapDiv.onclick = (e) => {
    e.stopPropagation();
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.top=0; overlay.style.left=0;
    overlay.style.width='100%'; overlay.style.height='100%';
    overlay.style.background='rgba(0,0,0,0.7)'; overlay.style.zIndex=9999;
    overlay.style.display='flex'; overlay.style.justifyContent='center'; overlay.style.alignItems='center';
    
    const mapContainer = document.createElement('div');
    mapContainer.style.width='80%'; mapContainer.style.height='80%'; mapContainer.style.border='2px solid #fff';
    overlay.appendChild(mapContainer);
    document.body.appendChild(overlay);

    const bigMap = L.map(mapContainer, {zoomControl:true, attributionControl:false}).setView([lat, lon], 17);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(bigMap);
    L.marker([lat, lon]).addTo(bigMap);

    // Cierra solo si clickea fuera del mapa
    overlay.addEventListener('click', (ev)=>{
      if(ev.target === overlay){
        bigMap.remove();
        overlay.remove();
      }
    });
  };
}
</script>
</body>
</html>
