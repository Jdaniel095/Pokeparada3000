<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer Helper</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:10px auto;padding:14px;background:#f7f9fb;color:#333;}
  h1{margin:4px 0 12px;text-align:center;color:#0b84ff}
  h2{color:#444;margin-top:22px}
  section{margin-bottom:24px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:260px}
  textarea{width:100%;min-height:120px;padding:8px;border-radius:6px;border:1px solid #ccc}
  .thumb{width:120px;height:90px;object-fit:cover;border:1px solid #ddd;border-radius:4px}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee;background:#fff;border-radius:6px;margin-bottom:6px}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer;transition:0.2s}
  button:hover{background:#e9e9e9}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white;border-radius:6px}
  #collageCanvas{background:#fff;max-width:100%}
  #collagePreview{margin-top:8px;max-width:100%;border:1px solid #ccc;display:block}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fff}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer;border-radius:4px;overflow:hidden}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px;text-align:center}
  .photo-preview{display:flex;gap:8px;align-items:center}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px;background:#fff}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  .files-wrap{max-height:300px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px;background:#fff}
  .final-card{display:flex;gap:12px;align-items:flex-start;padding:8px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
  .final-thumb{width:160px;height:120px;object-fit:cover;border:1px solid #ddd;border-radius:6px}
  .small-btn{padding:4px 8px;font-size:13px;border-radius:6px}
  .map-overlay-close{position:absolute;right:12px;top:12px;z-index:10001;background:#fff;border-radius:6px;padding:6px;border:1px solid #ccc;cursor:pointer}
</style>
</head>
<body>
  <h1>ðŸ“¸ Collage + Wayfarer Helper</h1>
  <div class="top-help">
    Flujo: 1) Conectar carpeta pÃºblica en Drive â†’ 2) Seleccionar fotos â†’ 3) Generar collage â†’ 4) Guardar ubicaciones â†’ 5) Pegar propuestas â†’ 6) Copiar campos.
  </div>

  <!-- 1. Conectar y listar carpeta de Drive -->
  <section>
    <h2>1) Listar fotos de la carpeta (Drive)</h2>
    <div class="controls-row">
      <button id="btnConnect" class="primary">Conectar y listar fotos</button>
      <button id="btnRefresh">Refrescar lista</button>
    </div>
    <div style="margin-top:8px" class="files-wrap" id="filesList"></div>
  </section>

  <!-- 2. Seleccionar y generar collage -->
  <section>
    <h2>2) Selecciona fotos y genera collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span style="margin-left:12px" class="badge">Cols: <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span style="margin-left:8px" class="badge">Ancho por foto(px): <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage (PNG)</button>
      <button id="btnClearSelection">Limpiar selecciÃ³n</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
        <img id="collagePreview" />
      </div>
    </div>
  </section>

  <!-- 3. Guardar ubicaciones -->
  <section>
    <h2>3) Guardar ubicaciones (desde tu mÃ³vil)</h2>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicaciÃ³n</button>
      <button id="btnExportLocations">Exportar ubicaciones</button>
      <button id="btnImportLocations">Importar ubicaciones</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <!-- 4. Pegar propuestas -->
  <section>
    <h2>4) Pegar propuestas</h2>
    <textarea id="proposalsInput" placeholder="Pega aquÃ­ las propuestas..."></textarea>
    <div class="controls-row">
      <button id="btnParse" class="primary">Parsear y asociar</button>
      <button id="btnClearProposals">Limpiar</button>
    </div>
    <div id="proposalsList"></div>
  </section>

  <!-- 5. Resultado final -->
  <section>
    <h2>5) Resultado final (foto + mapa + textos)</h2>
    <div id="finalList"></div>
  </section>

<script>
/* ========== CONFIG ========== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";

/* Estado */
let files = [];
let locations = [];
let proposals = {};

/* ---------- Persistencia ---------- */
function saveState(){
  localStorage.setItem("wf_files", JSON.stringify(files));
  localStorage.setItem("wf_locations", JSON.stringify(locations));
  localStorage.setItem("wf_proposals", JSON.stringify(proposals));
}
function loadState(){
  try{
    files = JSON.parse(localStorage.getItem("wf_files")||"[]");
    locations = JSON.parse(localStorage.getItem("wf_locations")||"[]");
    proposals = JSON.parse(localStorage.getItem("wf_proposals")||"{}");
  }catch(e){}
}

/* ---------- Funciones clave (abreviadas aquÃ­ por espacio) ---------- */
/* â†’ tu mismo cÃ³digo de listarDrive, renderFiles, collage, ubicaciones, propuestas y renderFinal,
   solo que despuÃ©s de cada acciÃ³n importante se llama saveState().
   Ejemplo: despuÃ©s de cambiar selecciÃ³n, de agregar ubicaciÃ³n o de parsear propuestas. */

/* Al inicio: */
window.addEventListener('load', ()=>{
  loadState();
  renderFiles();
  renderLocations();
  renderProposals();
  renderFinal();
});
</script>
</body>
</html>

