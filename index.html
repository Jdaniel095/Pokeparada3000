<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wayfarer Helper - Collage</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;margin:0;padding:0;background:#f4f6f9;color:#333;}
  header{background:#0b84ff;color:#fff;padding:14px;text-align:center;font-size:20px;font-weight:bold}
  section{margin:20px auto;max-width:1100px;padding:14px;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.1)}
  h2{margin:0 0 12px;color:#0b84ff;font-size:18px}
  .controls-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  button{padding:8px 14px;border-radius:6px;border:0;cursor:pointer;font-size:14px;transition:0.2s}
  button.primary{background:#0b84ff;color:#fff}
  button.primary:hover{background:#006ad1}
  button.secondary{background:#eee}
  button.secondary:hover{background:#ddd}
  .files-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;max-height:480px;overflow-y:auto;padding:6px}
  .file-card{position:relative;border:1px solid #ddd;border-radius:8px;overflow:hidden;background:#fafafa;cursor:pointer;transition:0.2s}
  .file-card:hover{box-shadow:0 2px 6px rgba(0,0,0,0.2)}
  .file-card img{width:100%;height:120px;object-fit:cover;display:block}
  .file-check{position:absolute;top:6px;left:6px;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #0b84ff;display:flex;align-items:center;justify-content:center;font-size:14px;color:#0b84ff}
  .file-card.selected .file-check{background:#0b84ff;color:#fff}
  .file-num{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:12px}
</style>
</head>
<body>
  <header>üì∏ Wayfarer Helper - Collage</header>

  <!-- 1. Conectar y listar fotos -->
  <section>
    <h2>1) Conectar y listar fotos (Drive)</h2>
    <div class="controls-row">
      <button id="btnConnect" class="primary">Conectar y listar</button>
      <button id="btnRefresh" class="secondary">Refrescar</button>
      <button id="btnSelectAll" class="secondary">Seleccionar todo</button>
      <button id="btnClearAll" class="secondary">Limpiar selecci√≥n</button>
    </div>
    <div id="filesList" class="files-wrap"></div>
  </section>

 <!-- 2. Seleccionar y generar collage -->
<section>
  <h2>2) Selecciona fotos y genera collage numerado</h2>
  <div class="controls-row">
    <button id="btnGenerateCollage" class="primary">üé® Generar collage</button>
    <button id="btnDownloadCollage">‚¨áÔ∏è Descargar collage</button>
  </div>

  <!-- Canvas oculto solo para generar el collage -->
  <canvas id="collageCanvas" style="display:none"></canvas>

  <!-- Preview reducido -->
  <div id="collageArea" style="margin-top:12px;text-align:center">
    <img id="collagePreview" 
         style="max-width:250px;cursor:pointer;display:none;border:1px solid #ccc;border-radius:6px"/>
  </div>
</section>
  
  <!-- Modal para agrandar el collage -->
<div id="modalCollage" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:9999">
  <img id="modalImg" style="max-width:90%;max-height:90%;border:3px solid white;border-radius:8px"/>
</div>

<!-- 3. Guardar ubicaciones -->
<section>
  <h2>3) Guardar ubicaciones (desde tu m√≥vil)</h2>
  <button id="btnSaveLocation" class="primary">üìç Guardar Ubicaci√≥n</button>

  <div id="locationsList" style="margin-top:15px;display:flex;flex-direction:column;gap:12px"></div>
</section>

<!-- Modal para ver mapa interactivo -->
<div id="modalMap" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:9999">
  <div style="position:relative;width:90%;height:90%">
    <div id="leafletMap" style="width:100%;height:100%;border:3px solid white;border-radius:8px"></div>
    <button onclick="closeMap()" style="position:absolute;top:10px;right:10px;padding:6px 10px;
     background:#fff;border:none;border-radius:4px;cursor:pointer">‚ùå Cerrar</button>
  </div>
</div>


  
<script>
/* ===== CONFIG ===== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";
const SHEET_URL = "https://script.google.com/macros/s/AKfycby0mJlQC7FMR18yS_kPLRuUDw3CbaWEFXuzQqGzuT6jkVdF-53TPvCeUW8UaBxRQWpT/exec";

let files = [];
let selected = new Set();

/* === 1. Listar archivos de Drive === */
async function listDriveFiles(){
  const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType,thumbnailLink,webContentLink)`;
  const res = await fetch(url);
  const data = await res.json();
  files = data.files || [];
  renderFiles();
}

/* === Renderizar lista === */
function renderFiles(){
  const cont = document.getElementById("filesList");
  cont.innerHTML = "";
  files.forEach((f,i)=>{
    const isSel = selected.has(f.id);
    // aseguramos thumbnail
    const thumb = f.thumbnailLink 
      ? f.thumbnailLink.replace(/=s\d+$/, "=s200") 
      : `https://drive.google.com/uc?export=view&id=${f.id}`;

    const div = document.createElement("div");
    div.className = "file-card"+(isSel?" selected":"");
    div.innerHTML = `
      <div class="file-check">${isSel?"‚úì":""}</div>
      <img src="${thumb}" alt="${f.name}">
      <div class="file-num">#${i+1}</div>
    `;
    div.onclick = ()=>{
      if(selected.has(f.id)) selected.delete(f.id);
      else selected.add(f.id);
      renderFiles();
    };
    cont.appendChild(div);
  });
}

/* === Botones === */
document.getElementById("btnConnect").onclick = listDriveFiles;
document.getElementById("btnRefresh").onclick = listDriveFiles;
document.getElementById("btnSelectAll").onclick = ()=>{
  files.forEach(f=>selected.add(f.id));
  renderFiles();
};
document.getElementById("btnClearAll").onclick = ()=>{
  selected.clear();
  renderFiles();
};
</script>
<script>
/* === Collage === */
function generateCollage(){
  const canvas = document.getElementById("collageCanvas");
  const ctx = canvas.getContext("2d");

  const selFiles = files.filter(f => selected.has(f.id));
  if(selFiles.length === 0){ alert("Selecciona fotos primero"); return; }

  const cols = 3; // columnas
  const w = 300; // ancho por foto
  const h = 220; // alto por foto
  const rows = Math.ceil(selFiles.length/cols);

  canvas.width = cols*w;
  canvas.height = rows*h;

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.font="20px Arial";
  ctx.fillStyle="#000";
  ctx.textAlign="left";

  selFiles.forEach((f,idx)=>{
    const img = new Image();
    img.crossOrigin="anonymous";
    img.onload=()=>{
      const row = Math.floor(idx/cols);
      const col = idx%cols;
      const x = col*w;
      const y = row*h;
      ctx.drawImage(img,x,y,w,h);
      ctx.fillStyle="rgba(0,0,0,0.6)";
      ctx.fillRect(x,y,40,28);
      ctx.fillStyle="#fff";
      ctx.fillText(`#${idx+1}`,x+8,y+20);
    };
    img.src = f.thumbnailLink 
      ? f.thumbnailLink.replace(/=s\d+$/, "=s400") 
      : `https://drive.google.com/uc?export=view&id=${f.id}`;
  });

  // mostrar preview
  setTimeout(()=>{
    const dataUrl = canvas.toDataURL("image/png");
    const preview = document.getElementById("collagePreview");
    preview.src = dataUrl;
    preview.style.display="block";
  },800);
}

function downloadCollage(){
  const canvas = document.getElementById("collageCanvas");
  const link = document.createElement("a");
  link.download="collage.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}

// Ampliar al hacer clic
document.getElementById("collagePreview").onclick = ()=>{
  const modal = document.getElementById("modalCollage");
  const modalImg = document.getElementById("modalImg");
  modal.style.display="flex";
  modalImg.src = document.getElementById("collagePreview").src;
};

// Cerrar modal
document.getElementById("modalCollage").onclick = ()=>{
  document.getElementById("modalCollage").style.display="none";
};

document.getElementById("btnGenerateCollage").onclick = generateCollage;
document.getElementById("btnDownloadCollage").onclick = downloadCollage;

let locations = [];
let counter = 1;
let currentMap = null;

/* === Guardar ubicaci√≥n con n√∫mero autom√°tico === */
function saveLocation(){
  if(!navigator.geolocation){
    alert("Geolocalizaci√≥n no soportada.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);

    const location = {
      id: Date.now(),
      order: counter,
      lat, lng
    };
    locations.push(location);
    counter++;
    renderLocations();
  }, err=>{
    alert("Error obteniendo ubicaci√≥n: " + err.message);
  });
}

/* === Renderizar la lista de ubicaciones === */
function renderLocations(){
  const list = document.getElementById("locationsList");
  list.innerHTML = "";

  locations.sort((a,b)=>a.order-b.order).forEach(loc=>{
    const div = document.createElement("div");
    div.style.display="flex";
    div.style.alignItems="center";
    div.style.justifyContent="space-between";
    div.style.gap="12px";
    div.style.border="1px solid #ccc";
    div.style.padding="8px";
    div.style.borderRadius="6px";
    div.style.background="#f9f9f9";

    // Mini-mapa satelital Leaflet (Esri World Imagery)
    const thumbDiv = document.createElement("div");
    thumbDiv.style.width = "150px";
    thumbDiv.style.height = "100px";
    thumbDiv.style.border = "1px solid #999";
    thumbDiv.style.borderRadius = "4px";
    thumbDiv.style.cursor = "pointer";
    div.appendChild(thumbDiv);

    const thumbMap = L.map(thumbDiv, {
  attributionControl: false,
  zoomControl: false,
  dragging: false,
  scrollWheelZoom: false,
  doubleClickZoom: false,
  boxZoom: false,
  keyboard: false,
  tap: false
});

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19 }
).addTo(thumbMap);

// √çcono m√°s peque√±o
const miniIcon = L.icon({
  iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
  iconSize: [20, 32],
  iconAnchor: [10, 32]
});

// Marcador y ajustar vista
const marker = L.marker([loc.lat, loc.lng], { icon: miniIcon }).addTo(thumbMap);
thumbMap.setView([loc.lat, loc.lng], 16);

// üîë Importante: refrescar para que el √≠cono no se ‚Äúpierda‚Äù
setTimeout(() => {
  thumbMap.invalidateSize();
}, 200);


    thumbDiv.onclick = () => openMap(loc.lat, loc.lng);

    // Detalles
    const details = document.createElement("div");
    details.innerHTML = `<strong>Propuesta ${loc.order}</strong><br>
                         üìç ${loc.lat}, ${loc.lng}`;
    div.appendChild(details);

    // Botones
    const controls = document.createElement("div");
    controls.style.display="flex";
    controls.style.flexDirection="row";
    controls.style.gap="6px";

    const btnUp = document.createElement("button");
    btnUp.textContent="‚¨ÜÔ∏è";
    btnUp.onclick=()=>moveLocation(loc.id,-1);

    const btnDown = document.createElement("button");
    btnDown.textContent="‚¨áÔ∏è";
    btnDown.onclick=()=>moveLocation(loc.id,1);

    const btnEdit = document.createElement("button");
    btnEdit.textContent="‚úèÔ∏è Editar #";
    btnEdit.onclick=()=>{
      const newOrder = parseInt(prompt("Nuevo n√∫mero de propuesta:", loc.order));
      if(!isNaN(newOrder)){
        loc.order=newOrder;
        renderLocations();
      }
    };

    const btnDelete = document.createElement("button");
    btnDelete.textContent="üóëÔ∏è Eliminar";
    btnDelete.onclick=()=>{
      locations=locations.filter(l=>l.id!==loc.id);
      renderLocations();
    };

    controls.appendChild(btnUp);
    controls.appendChild(btnDown);
    controls.appendChild(btnEdit);
    controls.appendChild(btnDelete);

    div.appendChild(controls);

    list.appendChild(div);
  });
}


/* === Mover arriba/abajo === */
function moveLocation(id,dir){
  const index = locations.findIndex(l=>l.id===id);
  if(index<0) return;
  const targetIndex = index+dir;
  if(targetIndex<0 || targetIndex>=locations.length) return;
  const tempOrder = locations[index].order;
  locations[index].order = locations[targetIndex].order;
  locations[targetIndex].order = tempOrder;
  renderLocations();
}

/* === Abrir mapa interactivo === */
function openMap(lat,lng){
  const modal = document.getElementById("modalMap");
  modal.style.display="flex";

  setTimeout(()=>{
    if(currentMap){ currentMap.remove(); }
    currentMap = L.map("leafletMap").setView([lat,lng],16);
  L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 19, attribution: "Tiles ¬© Esri" }
).addTo(currentMap);
    L.marker([lat,lng]).addTo(currentMap);
  },200);
}

/* === Cerrar mapa === */
function closeMap(){
  document.getElementById("modalMap").style.display="none";
  if(currentMap){
    currentMap.remove();
    currentMap = null;
  }
}

/* Cerrar modal si clic afuera */
document.getElementById("modalMap").onclick=(e)=>{
  if(e.target.id==="modalMap"){
    closeMap();
  }
};

/* Bot√≥n guardar */
document.getElementById("btnSaveLocation").onclick = saveLocation;
</script>
  
</body>
</html>
