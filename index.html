<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer Helper</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:10px auto;padding:14px;}
  h1{margin:4px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:260px}
  textarea{width:100%;min-height:120px}
  .thumb{width:120px;height:90px;object-fit:cover;border:1px solid #ddd;border-radius:4px}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white}
  #collageCanvas{background:#fff;max-width:100%}
  #collagePreview{margin-top:8px;max-width:100%;border:1px solid #ccc;display:block}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fafafa}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer;border-radius:4px;overflow:hidden}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  .files-wrap{max-height:300px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px}
  .final-card{display:flex;gap:12px;align-items:flex-start;padding:8px;border:1px solid #eee;border-radius:8px;margin-bottom:8px;background:white}
  .final-thumb{width:160px;height:120px;object-fit:cover;border:1px solid #ddd;border-radius:6px}
  .small-btn{padding:4px 8px;font-size:13px;border-radius:6px}
  .map-overlay-close{position:absolute;right:12px;top:12px;z-index:10001;background:#fff;border-radius:6px;padding:6px;border:1px solid #ccc;cursor:pointer}
  .hidden-card{display:none !important;}
</style>
</head>
<body>
  <h1>Collage + Wayfarer Helper</h1>
  <div class="top-help">
    Flujo: 1) carpeta Drive pública → 2) fotos → 3) collage → 4) ubicaciones → 5) propuestas → 6) resultado final.
  </div>

  <!-- Config -->
  <section>
    <h2>Configuración</h2>
    <p><b>IMPORTANTE:</b> API Key y Folder ID ya están puestos en el script.</p>
  </section>

  <hr/>

  <!-- 1. Conectar y listar carpeta -->
  <section>
    <h2>1) Fotos de la carpeta Drive</h2>
    <div class="controls-row">
      <button id="btnRefresh">Refrescar lista</button>
    </div>
    <div style="margin-top:8px" class="files-wrap" id="filesList"></div>
  </section>

  <hr/>

  <!-- 2. Collage -->
  <section>
    <h2>2) Generar collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span class="badge">Cols: <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span class="badge">Ancho px: <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage</button>
      <button id="btnClearSelection">Limpiar selección</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
        <img id="collagePreview" />
      </div>
    </div>
  </section>

  <hr/>

  <!-- 3. Ubicaciones -->
  <section>
    <h2>3) Guardar ubicaciones</h2>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicación</button>
      <button id="btnExportLocations">Exportar JSON</button>
      <button id="btnImportLocations">Importar JSON</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <hr/>

  <!-- 4. Propuestas -->
  <section>
    <h2>4) Pegar propuestas</h2>
    <textarea id="proposalsInput" placeholder="Pega aquí las propuestas..."></textarea>
    <div class="controls-row">
      <button id="btnParse" class="primary">Parsear y asociar</button>
      <button id="btnClearProposals">Limpiar</button>
    </div>
    <div id="proposalsList"></div>
  </section>

  <hr/>

  <!-- 5. Resultado final -->
  <section>
    <h2>5) Resultado final</h2>
    <div id="finalList"></div>
  </section>

<script>
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";

let files=[],locations=[],proposals={};

function driveDirectUrl(id){return `https://drive.google.com/uc?export=view&id=${id}`;}
function driveThumbUrl(id,size=200){return `https://drive.google.com/thumbnail?id=${id}&sz=w${size}`;}

async function listarDrive(){
  const q = encodeURIComponent(`'${FOLDER_ID}' in parents and mimeType contains 'image/' and trashed=false`);
  const url=`https://www.googleapis.com/drive/v3/files?q=${q}&key=${API_KEY}&supportsAllDrives=true&includeItemsFromAllDrives=true&fields=files(id,name,mimeType,thumbnailLink)`;
  const res=await fetch(url); const json=await res.json();
  if(json.error){alert(json.error.message);return;}
  files=(json.files||[])
    .filter(f=>/jpeg|jpg|png|gif/i.test(f.mimeType)) // FILTRO (solo imágenes comunes)
    .map(f=>({id:f.id,name:f.name,url:driveDirectUrl(f.id),thumb:f.thumbnailLink||driveThumbUrl(f.id,200),selected:false}));
  renderFiles();
}
document.getElementById('btnRefresh').onclick=()=>listarDrive();

function renderFiles(){
  const wrap=document.getElementById('filesList');wrap.innerHTML='';
  if(files.length===0){wrap.innerHTML='<small>No hay imágenes válidas.</small>';return;}
  files.forEach(f=>{
    const div=document.createElement('div');div.className='file-row';
    const cb=document.createElement('input');cb.type='checkbox';cb.checked=f.selected;
    cb.onchange=e=>{f.selected=e.target.checked;updateSelectedCount();renderFinal();}
    const img=document.createElement('img');img.className='thumb';img.src=f.thumb;
    div.append(cb,img,document.createTextNode(f.name));
    wrap.append(div);
  });
  updateSelectedCount();
}
function updateSelectedCount(){document.getElementById('selectedCount').innerText=files.filter(f=>f.selected).length;}

/* --- collage, ubicaciones, propuestas... (igual que antes) --- */
/* OMITO POR BREVEDAD — se mantienen tal cual, solo agrego el botón Ocultar en renderFinal() */

function renderFinal(){
  const wrap=document.getElementById('finalList');wrap.innerHTML='';
  const selected=files.filter(f=>f.selected);
  selected.forEach((f,i)=>{
    const num=i+1;
    const p=proposals[num]||{num,title:'',revisores:'',entrenadores:'',categoria:''};
    const card=document.createElement('div');card.className='final-card';card.id=`card-${num}`;
    const left=document.createElement('div');left.style.width='180px';
    const img=document.createElement('img');img.src=f.thumb||f.url;img.className='final-thumb';left.appendChild(img);
    const right=document.createElement('div');right.className='meta-box';
    right.innerHTML=`<b>Foto ${num}</b><br>
      <b>Título:</b> ${p.title}<br>
      <b>Revisores:</b> ${p.revisores}<br>
      <b>Entrenadores:</b> ${p.entrenadores}<br>
      <b>Categoría:</b> ${p.categoria}<br>`;
    const btnHide=document.createElement('button');btnHide.textContent='Ocultar';btnHide.onclick=()=>{card.classList.add('hidden-card');};
    right.appendChild(btnHide);
    card.append(left,right);wrap.append(card);
  });
}

/* auto listar al cargar */
window.addEventListener('load',()=>listarDrive());
</script>
</body>
</html>
