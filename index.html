<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gesti√≥n de Propuestas</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f8f9fb;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
    text-align: center;
  }
  h1 {
    color: #0b84ff;
  }
  h2 {
    margin-top: 25px;
    color: #333;
    border-bottom: 2px solid #eee;
    padding-bottom: 5px;
  }
  button {
    background: #1976d2;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin: 4px;
    font-size: 14px;
  }
  button:hover { background: #125aa0; }
  .file-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px;
    border-bottom: 1px solid #eee;
    background: #fff;
    border-radius: 6px;
    margin-bottom: 6px;
  }
  .thumb { width: 90px; height: 70px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; }
  #filesList { margin-top: 12px; text-align: left; }
  #collagePreview { margin-top: 10px; max-width: 250px; cursor: pointer; border: 2px solid #ddd; border-radius: 8px; }
  #modalCollage {
    display: none; position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999;
  }
  #modalCollage img { max-width: 90%; max-height: 90%; border: 3px solid #fff; border-radius: 10px; }
</style>
</head>
<body>
<div class="container">
  <h1>üì∏ Gesti√≥n de Propuestas</h1>

  <!-- ========================= -->
  <!-- 1) Conectar y listar Drive -->
  <!-- ========================= -->
  <h2>1) Listar fotos de la carpeta (Drive)</h2>
  <div>
    <button onclick="listarDrive()">üîÑ Listar fotos</button>
    <button onclick="seleccionarTodo()">‚úÖ Seleccionar todo</button>
  </div>
  <div id="filesList"></div>

  <!-- ========================= -->
  <!-- 2) Generar Collage -->
  <!-- ========================= -->
  <h2>2) Generar collage numerado</h2>
  <div>
    <button onclick="generarCollage()">üé® Generar collage</button>
    <button onclick="descargarCollage()">üíæ Descargar collage</button>
  </div>
  <canvas id="collageCanvas" style="display:none;"></canvas>
  <img id="collagePreview" onclick="abrirCollageModal()" />

  <!-- Modal collage -->
  <div id="modalCollage" onclick="cerrarCollageModal()">
    <img id="modalCollageImg" />
  </div>

  <!-- ========================= -->
  <!-- 3) Guardar Ubicaci√≥n -->
  <!-- ========================= -->
  <h2>3) Guardar Ubicaci√≥n</h2>
  <div>
    <label>N√∫mero de foto:</label>
    <input type="number" id="fotoNumero" min="1" placeholder="Ej: 5">
    <button onclick="activarUbicacion()">üìç Usar ubicaci√≥n actual</button>
  </div>
  <div id="ubicacionesList" style="display:flex; flex-direction:column; gap:10px; max-width:800px; margin:auto;"></div>

  <!-- Modal mapa -->
  <div id="modalUbicacion" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
    <span onclick="cerrarModal()" style="position:absolute; top:15px; right:25px; font-size:30px; color:white; cursor:pointer;">&times;</span>
    <div id="modalMap" style="width:90%; height:80%; border:2px solid #fff; border-radius:8px;"></div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";

/* ====== SECCI√ìN 1: DRIVE ====== */
let files = [];
let seleccionados = [];

function listarDrive() {
  const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}&fields=files(id,name,mimeType)`;
  fetch(url).then(r => r.json()).then(data => {
    files = data.files || [];
    renderFiles();
  });
}

function renderFiles() {
  const list = document.getElementById("filesList");
  list.innerHTML = "";
  files.forEach((f, idx) => {
    const row = document.createElement("div");
    row.className = "file-row";
    const img = document.createElement("img");
    img.className = "thumb";
    img.src = `https://drive.google.com/thumbnail?id=${f.id}`;
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.dataset.id = f.id;
    chk.onchange = () => {
      if (chk.checked) { seleccionados.push(f); } 
      else { seleccionados = seleccionados.filter(x => x.id !== f.id); }
    };
    const label = document.createElement("span");
    label.textContent = `${idx+1}. ${f.name}`;
    row.appendChild(chk); row.appendChild(img); row.appendChild(label);
    list.appendChild(row);
  });
}

function seleccionarTodo() {
  seleccionados = [...files];
  document.querySelectorAll("#filesList input[type=checkbox]").forEach(chk => chk.checked = true);
}

/* ====== SECCI√ìN 2: COLLAGE ====== */
function generarCollage() {
  if (seleccionados.length === 0) { alert("Selecciona fotos primero"); return; }
  const canvas = document.getElementById("collageCanvas");
  const ctx = canvas.getContext("2d");
  const cols = 3;
  const size = 200;
  const rows = Math.ceil(seleccionados.length / cols);
  canvas.width = cols * size;
  canvas.height = rows * size;
  ctx.fillStyle = "#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);

  seleccionados.forEach((f, idx) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      const x = (idx % cols) * size;
      const y = Math.floor(idx / cols) * size;
      ctx.drawImage(img, x, y, size, size);
      ctx.fillStyle = "red";
      ctx.font = "20px Arial";
      ctx.fillText(idx+1, x+10, y+25);
      document.getElementById("collagePreview").src = canvas.toDataURL("image/png");
    };
    img.src = `https://drive.google.com/uc?id=${f.id}`;
  });
}

function descargarCollage() {
  const canvas = document.getElementById("collageCanvas");
  const link = document.createElement("a");
  link.download = "collage.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}

function abrirCollageModal() {
  document.getElementById("modalCollageImg").src = document.getElementById("collagePreview").src;
  document.getElementById("modalCollage").style.display = "flex";
}
function cerrarCollageModal() {
  document.getElementById("modalCollage").style.display = "none";
}

/* ====== SECCI√ìN 3: UBICACIONES ====== */
let ubicaciones = [];

function activarUbicacion() {
  const numeroFoto = document.getElementById("fotoNumero").value;
  if (!numeroFoto) { alert("Por favor ingresa el n√∫mero de foto"); return; }
  if (!navigator.geolocation) { alert("Tu navegador no soporta geolocalizaci√≥n"); return; }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const fechaHora = new Date().toLocaleString();
    ubicaciones.push({ numero: parseInt(numeroFoto), lat, lng, fecha: fechaHora });
    mostrarUbicaciones();
  }, err => alert("Error al obtener ubicaci√≥n: " + err.message));
}

function mostrarUbicaciones() {
  const cont = document.getElementById("ubicacionesList");
  cont.innerHTML = "";
  ubicaciones.forEach((u, idx) => {
    const card = document.createElement("div");
    card.style.display = "flex"; card.style.alignItems = "center";
    card.style.border = "1px solid #ccc"; card.style.padding = "8px";
    card.style.borderRadius = "6px"; card.style.background = "#fff"; card.style.gap = "12px";

    const mapDiv = document.createElement("div");
    mapDiv.style.width = "200px"; mapDiv.style.height = "150px";
    mapDiv.style.cursor = "pointer"; mapDiv.id = "map_" + idx;

    const infoDiv = document.createElement("div");
    infoDiv.innerHTML = `
      <strong>Propuesta ${u.numero}</strong><br>
      üìç Lat: ${u.lat.toFixed(5)}, Lng: ${u.lng.toFixed(5)}<br>
      ‚è∞ ${u.fecha}
      <br>
      <button onclick="editarNumero(${idx})">‚úèÔ∏è Editar n√∫mero</button>
      <button onclick="moverArriba(${idx})">‚¨ÜÔ∏è</button>
      <button onclick="moverAbajo(${idx})">‚¨áÔ∏è</button>
      <button onclick="eliminarUbicacion(${idx})">üóëÔ∏è</button>
    `;

    card.appendChild(mapDiv); card.appendChild(infoDiv); cont.appendChild(card);

    const map = L.map(mapDiv.id).setView([u.lat, u.lng], 18);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri'
    }).addTo(map);
    L.marker([u.lat, u.lng]).addTo(map);

    mapDiv.onclick = () => abrirModal(u.lat, u.lng);
  });
}

function editarNumero(idx) {
  const nuevo = prompt("Nuevo n√∫mero de foto:", ubicaciones[idx].numero);
  if (nuevo) { ubicaciones[idx].numero = parseInt(nuevo); mostrarUbicaciones(); }
}
function eliminarUbicacion(idx) { if (confirm("¬øEliminar esta ubicaci√≥n?")) { ubicaciones.splice(idx, 1); mostrarUbicaciones(); } }
function moverArriba(idx) { if (idx > 0) { [ubicaciones[idx-1], ubicaciones[idx]] = [ubicaciones[idx], ubicaciones[idx-1]]; mostrarUbicaciones(); } }
function moverAbajo(idx) { if (idx < ubicaciones.length - 1) { [ubicaciones[idx+1], ubicaciones[idx]] = [ubicaciones[idx], ubicaciones[idx+1]]; mostrarUbicaciones(); } }

function abrirModal(lat, lng) {
  document.getElementById("modalUbicacion").style.display = "flex";
  setTimeout(() => {
    const modalMap = L.map("modalMap").setView([lat, lng], 18);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri'
    }).addTo(modalMap);
    L.marker([lat, lng]).addTo(modalMap);
  }, 200);
}
function cerrarModal() {
  document.getElementById("modalUbicacion").style.display = "none";
  document.getElementById("modalMap").innerHTML = "";
}
</script>
</body>
</html>
