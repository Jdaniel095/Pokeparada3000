<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer Helper</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:10px auto;padding:14px;}
  h1{margin:4px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:260px}
  textarea{width:100%;min-height:120px}
  .thumb{width:120px;height:90px;object-fit:contain;border:1px solid #ddd}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white}
  #collageCanvas{background:#fff;max-width:100%}
  #collagePreview{margin-top:8px;max-width:100%;border:1px solid #ccc;display:block}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fafafa}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px}
  .photo-preview{display:flex;gap:8px;align-items:center}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  .files-wrap{max-height:300px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px}
</style>
</head>
<body>
  <h1>Collage + Wayfarer Helper</h1>
  <div class="top-help">
    Flujo: 1) configura carpeta pública en Drive + API Key → 2) conectar → 3) seleccionar fotos → 4) generar collage → 5) guardar ubicaciones → 6) pegar propuestas que yo te entregue → 7) copiar campos.
  </div>

  <!-- Config -->
  <section>
    <h2>Configuración (reemplazar en el archivo)</h2>
    <p><b>IMPORTANTE:</b> en el código reemplaza <code>YOUR_API_KEY_HERE</code> y <code>YOUR_FOLDER_ID_HERE</code> por tus valores.</p>
    <p>Carpeta pública en Drive: añade colaboradores como <b>Editor</b> si quieres que otros suban fotos.</p>
  </section>

  <hr/>

  <!-- 1. Conectar y listar carpeta de Drive -->
  <section>
    <h2>1) Listar fotos de la carpeta (Drive)</h2>
    <div class="controls-row">
      <button id="btnConnect" class="primary">Conectar y listar fotos</button>
      <button id="btnRefresh">Refrescar lista</button>
    </div>
    <div style="margin-top:8px" class="files-wrap" id="filesList"></div>
  </section>

  <hr/>

  <!-- 2. Seleccionar y generar collage -->
  <section>
    <h2>2) Selecciona fotos y genera collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span style="margin-left:12px" class="badge">Cols: <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span style="margin-left:8px" class="badge">Ancho por foto(px): <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage (PNG)</button>
      <button id="btnClearSelection">Limpiar selección</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
        <img id="collagePreview" />
      </div>
    </div>
  </section>

  <hr/>

  <!-- 3. Guardar ubicaciones (móvil) -->
  <section>
    <h2>3) Guardar ubicaciones (desde tu móvil)</h2>
    <p>Abre esta página en tu móvil y pulsa <b>Guardar ubicación</b> en cada punto. Asigna el número que corresponda con la foto del collage (ej. 1).</p>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicación</button>
      <button id="btnExportLocations">Exportar ubicaciones (JSON)</button>
      <button id="btnImportLocations">Importar ubicaciones</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <hr/>

  <!-- 4. Pegar propuestas -->
  <section>
    <h2>4) Pegar propuestas (formato que yo doy)</h2>
    <p style="color:#666">Formato exacto de ejemplo:</p>
    <pre>Foto 1
Título: Título sugerido
Revisores: Texto para el revisor...
Entrenadores: Texto para entrenadores...
Categoría: Point of Interest

Foto 2
...</pre>
    <textarea id="proposalsInput" placeholder="Pega aquí las propuestas que te doy..."></textarea>
    <div class="controls-row">
      <button id="btnParse" class="primary">Parsear y asociar</button>
      <button id="btnClearProposals">Limpiar</button>
    </div>
    <div id="proposalsList"></div>
  </section>

  <hr/>

  <!-- 5. Resultado final -->
  <section>
    <h2>5) Resultado final (foto + mapa + textos)</h2>
    <div id="finalList"></div>
  </section>

<script>
/* ========== REEMPLAZA ESTOS VALORES ========== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";       
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";   
/* ============================================= */

if(API_KEY.includes("YOUR_") || FOLDER_ID.includes("YOUR_")){
  console.warn("Recuerda reemplazar API_KEY y FOLDER_ID en el archivo index.html");
}

/* -----------------------
   Helpers Drive -> URL directa
----------------------- */
function driveDirectUrl(id){
  return `https://drive.google.com/uc?id=${id}`;
}

/* -----------------------
   Estado
----------------------- */
let files = []; // {id,name,url,selected}
let locations = []; // {num,lat,lon,time}
let proposals = {}; // num -> {num,title,revisores,entrenadores,categoria}

/* -----------------------
   Listar archivos de Drive
----------------------- */
async function listarDrive(){
  const q = encodeURIComponent(`'${FOLDER_ID}' in parents and mimeType contains 'image/' and trashed=false`);
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&key=${API_KEY}&fields=files(id,name,mimeType,thumbnailLink,webViewLink,webContentLink)&pageSize=300`;
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(json.error){ alert("Error Drive API: " + (json.error.message||JSON.stringify(json.error))); return; }
    files = (json.files||[]).map(f=>({id:f.id, name:f.name, url:driveDirectUrl(f.id), selected:false}));
    renderFiles();
  }catch(err){
    alert("Error al listar Drive: "+err.message);
  }
}

document.getElementById('btnConnect').addEventListener('click', ()=>listarDrive());
document.getElementById('btnRefresh').addEventListener('click', ()=>listarDrive());

/* -----------------------
   Render archivos
----------------------- */
function renderFiles(){
  const wrap = document.getElementById('filesList');
  wrap.innerHTML = '';
  if(files.length===0){ wrap.innerHTML = '<small>No se encontraron imágenes. Asegúrate que la carpeta es pública y contiene imágenes.</small>'; return; }
  files.forEach((f,idx)=>{
    const div = document.createElement('div'); div.className='file-row';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!f.selected;
    cb.addEventListener('change', e=>{ f.selected = e.target.checked; updateSelectedCount(); });
    const img = document.createElement('img'); img.className='thumb'; img.src = f.url;
    img.onerror = ()=>{ img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="90"><rect width="100%" height="100%" fill="%23eee"/><text x="50%" y="50%" font-size="12" text-anchor="middle" fill="%23666" dy=".3em">No preview</text></svg>'};
    const span = document.createElement('div'); span.style.flex='1'; span.innerText = f.name;
    div.appendChild(cb); div.appendChild(img); div.appendChild(span);
    wrap.appendChild(div);
  });
  updateSelectedCount();
}

function updateSelectedCount(){
  const c = files.filter(f=>f.selected).length;
  document.getElementById('selectedCount').innerText = c;
}

/* -----------------------
   Generar collage usando canvas y miniatura
----------------------- */
const collageCanvas = document.getElementById('collageCanvas');
const collagePreview = document.getElementById('collagePreview');

document.getElementById('btnGenerate').addEventListener('click', async ()=>{
  const selected = files.filter(f=>f.selected);
  if(selected.length===0){ alert("Selecciona al menos una foto."); return; }
  const cols = Math.max(1, parseInt(document.getElementById('colsInput').value) || 3);
  const w = Math.max(80, parseInt(document.getElementById('wInput').value) || 300);
  const h = Math.round(w * 0.75);
  const imgs = await Promise.all(selected.map(s=>loadImage(s.url).then(img=>({img, name:s.name})).catch(e=>{console.warn("Error cargando imagen", s.url, e); return null;})));
  const valid = imgs.filter(Boolean);
  const rows = Math.ceil(valid.length/cols);
  collageCanvas.width = cols * w + (cols+1)*8;
  collageCanvas.height = rows * h + (rows+1)*8;
  const ctx = collageCanvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,collageCanvas.width,collageCanvas.height);
  valid.forEach((o,i)=>{
    const r = Math.floor(i/cols), c = i%cols;
    const x = 8 + c*(w+8), y = 8 + r*(h+8);
    const img = o.img;
    const ratio = Math.max(w/img.width, h/img.height);
    const sw = Math.round(w/ratio), sh = Math.round(h/ratio);
    const sx = Math.max(0, Math.round((img.width - sw)/2));
    const sy = Math.max(0, Math.round((img.height - sh)/2));
    ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    const num = i+1;
    ctx.fillStyle='rgba(0,0,0,0.6)';
    ctx.fillRect(x+6, y+6, 34, 28);
    ctx.fillStyle='white'; ctx.font='18px sans-serif'; ctx.fillText(num.toString(), x+16, y+26);
  });
  collagePreview.src = collageCanvas.toDataURL('image/png');
  alert("Collage generado. Pulsa Descargar para guardar la imagen.");
});

function loadImage(url){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=>resolve(img);
    img.onerror = (e) => reject(e);
    img.src = url;
  });
}

document.getElementById('btnDownload').addEventListener('click', ()=>{
  if(!collageCanvas.width){ alert("Genera primero el collage."); return;}
  const a = document.createElement('a');
  a.href = collageCanvas.toDataURL('image/png');
  a.download = 'collage.png';
  a.click();
});

document.getElementById('btnClearSelection').addEventListener('click', ()=>{ files.forEach(f=>f.selected=false); renderFiles(); });

/* -----------------------
   Ubicaciones: geolocalización + mapas clicables
----------------------- */
function makeMapClickable(mapDiv, lat, lon){
  mapDiv.style.cursor = 'pointer';
  mapDiv.onclick = () => {
    const overlay = document.createElement('div');
    overlay.style.position='fixed'; overlay.style.top=0; overlay.style.left=0;
    overlay.style.width='100%'; overlay.style.height='100%';
    overlay.style.background='rgba(0,0,0,0.7)'; overlay.style.zIndex=9999;
    overlay.style.display='flex'; overlay.style.justifyContent='center'; overlay.style.alignItems='center';
    const mapContainer = document.createElement('div');
    mapContainer.style.width='80%'; mapContainer.style.height='80%'; mapContainer.style.border='2px solid #fff';
    overlay.appendChild(mapContainer);
    document.body.appendChild(overlay);
    const bigMap = L.map(mapContainer, {zoomControl:true, attributionControl:false}).setView([lat, lon], 17);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(bigMap);
    L.marker([lat, lon]).addTo(bigMap);
    overlay.onclick = () => { bigMap.remove(); overlay.remove(); };
  };
}

document.getElementById('btnSaveLocation').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("Tu navegador no soporta geolocalización."); return; }
  const num = prompt("Asigna un número para esta ubicación (ej. 1):");
  if(!num) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const t = new Date().toISOString();
    locations.push({num: parseInt(num), lat, lon, time: t});
    renderLocations();
  },err=>{ alert("Error al obtener ubicación: "+err.message); },{enableHighAccuracy:true, timeout:10000});
});

document.getElementById('btnExportLocations').addEventListener('click', ()=>{
  const data = JSON.stringify(locations,null,2);
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download = 'ubicaciones.json'; a.click();
});

document.getElementById('btnImportLocations').addEventListener('click', ()=> document.getElementById('locFile').click());
document.getElementById('locFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{ try{ locations = JSON.parse(r.result); renderLocations(); }catch(err){ alert("JSON inválido") } };
  r.readAsText(f);
});

function renderLocations(){
  const wrap = document.getElementById('locationsList'); wrap.innerHTML='';
  locations.forEach(loc=>{
    const div = document.createElement('div'); div.className='line-item';
    const mapDiv = document.createElement('div'); mapDiv.className='smallmap';
    setTimeout(()=>{
      const map = L.map(mapDiv, {zoomControl:false, attributionControl:false}).setView([loc.lat, loc.lon], 17);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(map);
      L.marker([loc.lat, loc.lon]).addTo(map);
      map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); map.scrollWheelZoom.disable();
      makeMapClickable(mapDiv, loc.lat, loc.lon);
    },50);
    const meta = document.createElement('div'); meta.className='meta-box';
    meta.innerHTML = `<b>Número:</b> ${loc.num}<br/><b>Lat:</b> ${loc.lat.toFixed(6)} <b>Lon:</b> ${loc.lon.toFixed(6)}<br/><small>${loc.time}</small>`;
    const btnDel = document.createElement('button'); btnDel.textContent='Eliminar'; btnDel.onclick=()=>{ locations = locations.filter(l=>!(l.num===loc.num && l.lat===loc.lat)); renderLocations(); };
    div.appendChild(mapDiv); div.appendChild(meta); div.appendChild(btnDel);
    wrap.appendChild(div);
  });
}

/* -----------------------
   Parsear propuestas pegadas y asociar
----------------------- */
document.getElementById('btnParse').addEventListener('click', ()=>{
  const raw = document.getElementById('proposalsInput').value.trim();
  if(!raw){ alert("Pega las propuestas que yo te doy."); return;}
  const parts = raw.split(/\r?\n(?=Foto\s*\d+)/i);
  proposals = {};
  parts.forEach(block=>{
    const lines = block.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(lines.length===0) return;
    const m = lines[0].match(/Foto\s*([0-9]+)/i);
    if(!m) return;
    const num = parseInt(m[1]);
    const obj = {num, title:'', revisores:'', entrenadores:'', categoria:''};
    lines.slice(1).forEach(line=>{
      const k = line.match(/^([^:]+):\s*(.*)$/);
      if(k){
        const key = k[1].toLowerCase();
        const val = k[2];
        if(key.includes('título')||key.includes('titulo')||key.includes('title')) obj.title = val;
        else if(key.includes('revisor')) obj.revisores = val;
        else if(key.includes('entrenador')) obj.entrenadores = val;
        else if(key.includes('categoria')||key.includes('categoría')) obj.categoria = val;
      }
    });
    proposals[num] = obj;
  });
  renderProposals();
  renderFinal();
});

function renderProposals(){
  const wrap = document.getElementById('proposalsList'); wrap.innerHTML='';
  Object.keys(proposals).sort((a,b)=>a-b).forEach(k=>{
    const p = proposals[k];
    const d = document.createElement('div'); d.className='proposal';
    d.innerHTML = `<b>Foto ${p.num}</b><br/><b>Título:</b> ${p.title}<br/><b>Revisores:</b> ${short(p.revisores)}<br/><b>Entrenadores:</b> ${short(p.entrenadores)}<br/><b>Categoría:</b> ${p.categoria}`;
    wrap.appendChild(d);
  });
}
function short(s){ if(!s) return ''; return s.length>120 ? s.slice(0,120)+'…' : s; }

/* -----------------------
   Mostrar final: asociar foto, mapa, textos, botones copiar y ocultar
----------------------- */
function renderFinal(){
  const wrap = document.getElementById('finalList'); wrap.innerHTML='';
  const selected = files.filter(f=>f.selected);
  selected.forEach((f,i)=>{
    const num = i+1;
    const p = proposals[num] || {num, title:'', revisores:'', entrenadores:'', categoria:''};
    const loc = locations.find(l=>l.num===num);
    const item = document.createElement('div'); item.className='line-item';
    const left = document.createElement('div'); left.style.width='160px';
    const img = document.createElement('img'); img.src = f.url; img.className='thumb';
    left.appendChild(img);
    const mapDiv = document.createElement('div'); mapDiv.style.marginTop='6px';
    if(loc){
      mapDiv.className = 'smallmap';
      setTimeout(()=>{
        const map = L.map(mapDiv, {zoomControl:false, attributionControl:false}).setView([loc.lat, loc.lon], 17);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(map);
        L.marker([loc.lat, loc.lon]).addTo(map);
        map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); map.scrollWheelZoom.disable();
        makeMapClickable(mapDiv, loc.lat, loc.lon);
      },50);
    } else {
      mapDiv.innerHTML = '<small style="color:#666">Sin ubicación guardada para este número</small>';
    }
    left.appendChild(mapDiv);

    const right = document.createElement('div'); right.className='meta-box';
    right.innerHTML = `<b>Foto ${num}</b>
      <div><b>Título:</b> <span id="t-${num}">${escapeHtml(p.title)}</span>
        <button data-copy="t-${num}" class="copy-btn">Copiar</button>
      </div>
      <div><b>Revisores:</b> <span id="r-${num}">${escapeHtml(p.revisores)}</span>
        <button data-copy="r-${num}" class="copy-btn">Copiar</button>
      </div>
      <div><b>Entrenadores:</b> <span id="e-${num}">${escapeHtml(p.entrenadores)}</span>
        <button data-copy="e-${num}" class="copy-btn">Copiar</button>
      </div>
      <div><b>Categoría:</b> <span id="c-${num}">${escapeHtml(p.categoria)}</span>
        <button data-copy="c-${num}" class="copy-btn">Copiar</button>
      </div>
      <div style="margin-top:8px">
        <button class="btn-hide" data-num="${num}">Ocultar / mostrar propuesta</button>
      </div>
    `;
    item.appendChild(left); item.appendChild(right);
    wrap.appendChild(item);
  });

  document.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const id = btn.getAttribute('data-copy');
      const txt = document.getElementById(id).innerText;
      copyToClipboard(txt).then(()=>{ btn.textContent='Copiado'; setTimeout(()=>btn.textContent='Copiar',900); });
    });
  });
  document.querySelectorAll('.btn-hide').forEach(b=>{
    b.addEventListener('click', (ev)=>{
      const n = b.getAttribute('data-num');
      ['t','r','e','c'].forEach(pref=>{
        const elsp = document.getElementById(pref+'-'+n);
        if(!elsp) return;
        elsp.style.display = (elsp.style.display==='none')? 'inline' : 'none';
      });
      b.textContent = b.textContent.includes('Ocultar') ? 'Mostrar propuesta' : 'Ocultar propuesta';
    });
  });
}

function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function copyToClipboard(text){
  if(navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
  return new Promise((res,rej)=>{
    const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); ta.remove(); res(); }catch(e){ ta.remove(); rej(e); }
  });
}

</script>

</body>
</html>
