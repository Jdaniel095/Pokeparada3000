<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer Helper</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:10px auto;padding:14px;}
  h1{margin:4px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 320px;min-width:260px}
  textarea{width:100%;min-height:120px}
  .thumb{width:120px;height:90px;object-fit:contain;border:1px solid #ddd}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white}
  #collageCanvas{background:#fff;max-width:100%}
  #collagePreview{margin-top:8px;max-width:100%;border:1px solid #ccc;display:block}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fafafa}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px}
  .photo-preview{display:flex;gap:8px;align-items:center}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  .files-wrap{max-height:300px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px}
</style>
</head>
<body>
  <h1>Collage + Wayfarer Helper</h1>
  <div class="top-help">
    Flujo: 1) configurar carpeta pública en Drive + API Key → 2) conectar → 3) seleccionar fotos → 4) generar collage → 5) guardar ubicaciones → 6) pegar propuestas → 7) copiar campos.
  </div>

  <!-- Config -->
  <section>
    <h2>Configuración (reemplazar en el archivo)</h2>
    <p><b>IMPORTANTE:</b> Reemplaza <code>API_KEY</code> y <code>FOLDER_ID</code> con tus valores.</p>
  </section>

  <hr/>

  <!-- 1. Conectar y listar carpeta de Drive -->
  <section>
    <h2>1) Listar fotos de la carpeta (Drive)</h2>
    <div class="controls-row">
      <button id="btnConnect" class="primary">Conectar y listar fotos</button>
      <button id="btnRefresh">Refrescar lista</button>
    </div>
    <div style="margin-top:8px" class="files-wrap" id="filesList"></div>
  </section>

  <hr/>

  <!-- 2. Seleccionar y generar collage -->
  <section>
    <h2>2) Selecciona fotos y genera collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span style="margin-left:12px" class="badge">Cols: <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span style="margin-left:8px" class="badge">Ancho por foto(px): <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage (PNG)</button>
      <button id="btnClearSelection">Limpiar selección</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
        <img id="collagePreview" />
      </div>
    </div>
  </section>

  <hr/>

  <!-- 3. Guardar ubicaciones -->
  <section>
    <h2>3) Guardar ubicaciones</h2>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicación</button>
      <button id="btnExportLocations">Exportar ubicaciones (JSON)</button>
      <button id="btnImportLocations">Importar ubicaciones</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <hr/>

  <!-- 4. Pegar propuestas -->
  <section>
    <h2>4) Pegar propuestas</h2>
    <textarea id="proposalsInput" placeholder="Pega aquí las propuestas..."></textarea>
    <div class="controls-row">
      <button id="btnParse" class="primary">Parsear y asociar</button>
      <button id="btnClearProposals">Limpiar</button>
    </div>
    <div id="proposalsList"></div>
  </section>

  <hr/>

  <!-- 5. Resultado final -->
  <section>
    <h2>5) Resultado final</h2>
    <div id="finalList"></div>
  </section>

<script>
/* ========== REEMPLAZA ESTOS VALORES ========== */
const API_KEY = "AIzaSyAzq7mmTZTExpbetLRCkbopY5pDPBvOki4";       
const FOLDER_ID = "1SykigPCl4e003n6i2_PbopBrq22droo4";   
/* ============================================= */

function driveDirectUrl(id){ return `https://drive.google.com/uc?id=${id}`; }

/* Estado */
let files = []; 
let locations = []; 
let proposals = {}; 

/* Listar archivos de Drive */
async function listarDrive(){
  const q = encodeURIComponent(`'${FOLDER_ID}' in parents and mimeType contains 'image/' and trashed=false`);
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&key=${API_KEY}&fields=files(id,name,mimeType,thumbnailLink)&pageSize=300`;
  try{
    const res = await fetch(url);
    const json = await res.json();
    if(json.error){ alert("Error Drive API: " + json.error.message); return; }
    files = (json.files||[]).map(f=>({
      id: f.id,
      name: f.name,
      url: driveDirectUrl(f.id),
      thumb: f.thumbnailLink || `https://drive.google.com/thumbnail?id=${f.id}&sz=w200`,
      selected:false
    }));
    renderFiles();
  }catch(err){ alert("Error al listar Drive: "+err.message); }
}
document.getElementById('btnConnect').addEventListener('click', listarDrive);
document.getElementById('btnRefresh').addEventListener('click', listarDrive);

/* Render archivos */
function renderFiles(){
  const wrap = document.getElementById('filesList');
  wrap.innerHTML = '';
  if(files.length===0){ wrap.innerHTML = '<small>No se encontraron imágenes.</small>'; return; }
  files.forEach((f)=>{
    const div = document.createElement('div'); div.className='file-row';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!f.selected;
    cb.addEventListener('change', e=>{ f.selected = e.target.checked; updateSelectedCount(); });
    const img = document.createElement('img'); img.className='thumb'; img.src = f.thumb;
    const span = document.createElement('div'); span.style.flex='1'; span.innerText = f.name;
    div.appendChild(cb); div.appendChild(img); div.appendChild(span);
    wrap.appendChild(div);
  });
  updateSelectedCount();
}
function updateSelectedCount(){
  const c = files.filter(f=>f.selected).length;
  document.getElementById('selectedCount').innerText = c;
}

/* Generar collage */
document.getElementById('btnGenerate').addEventListener('click', async ()=>{
  const selected = files.filter(f=>f.selected);
  if(selected.length===0){ alert("Selecciona al menos una foto."); return; }
  const cols = parseInt(document.getElementById('colsInput').value)||3;
  const w = parseInt(document.getElementById('wInput').value)||300;
  const rows = Math.ceil(selected.length/cols);
  const h = w*0.75; // proporción 4:3
  const canvas = document.getElementById('collageCanvas');
  canvas.width = cols*w; canvas.height = rows*h;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);

  let i=0;
  for(const f of selected){
    const img = await loadImage(f.url);
    const x=(i%cols)*w, y=Math.floor(i/cols)*h;
    ctx.drawImage(img,x,y,w,h);
    ctx.fillStyle="rgba(0,0,0,0.6)";
    ctx.fillRect(x,y,28,20);
    ctx.fillStyle="#fff"; ctx.font="14px sans-serif";
    ctx.fillText(i+1,x+4,y+15);
    i++;
  }
  document.getElementById('collagePreview').src = canvas.toDataURL();
});
document.getElementById('btnDownload').addEventListener('click', ()=>{
  const a=document.createElement('a');
  a.href=document.getElementById('collageCanvas').toDataURL("image/png");
  a.download="collage.png"; a.click();
});
document.getElementById('btnClearSelection').addEventListener('click', ()=>{
  files.forEach(f=>f.selected=false); renderFiles();
});
function loadImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin="anonymous"; img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }

/* Ubicaciones */
document.getElementById('btnSaveLocation').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("Geolocalización no soportada."); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    locations.push({lat:pos.coords.latitude, lon:pos.coords.longitude});
    renderLocations();
  },err=>alert("Error geolocalización: "+err.message));
});
function renderLocations(){
  const wrap=document.getElementById('locationsList'); wrap.innerHTML="";
  locations.forEach((l,i)=>{
    const div=document.createElement('div'); div.textContent=`#${i+1}: ${l.lat.toFixed(5)}, ${l.lon.toFixed(5)}`;
    wrap.appendChild(div);
  });
}
document.getElementById('btnExportLocations').addEventListener('click', ()=>{
  const a=document.createElement('a');
  a.href="data:application/json,"+encodeURIComponent(JSON.stringify(locations));
  a.download="ubicaciones.json"; a.click();
});
document.getElementById('btnImportLocations').addEventListener('click', ()=>document.getElementById('locFile').click());
document.getElementById('locFile').addEventListener('change', e=>{
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader(); r.onload=()=>{ locations=JSON.parse(r.result); renderLocations(); };
  r.readAsText(file);
});

/* Parsear propuestas */
document.getElementById('btnParse').addEventListener('click', ()=>{
  const txt=document.getElementById('proposalsInput').value.trim();
  if(!txt){ alert("Pega propuestas primero."); return; }
  const lines=txt.split(/\n+/);
  proposals={};
  lines.forEach((line,i)=>{ proposals[i+1]=line; });
  renderProposals();
});
document.getElementById('btnClearProposals').addEventListener('click', ()=>{
  proposals={}; document.getElementById('proposalsList').innerHTML="";
});
function renderProposals(){
  const wrap=document.getElementById('proposalsList'); wrap.innerHTML="";
  Object.entries(proposals).forEach(([idx,text])=>{
    const div=document.createElement('div'); div.className="proposal";
    div.textContent=`#${idx}: ${text}`;
    wrap.appendChild(div);
  });
}
</script>
</body>
</html>
