<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Collage + Wayfarer helper</title>

<!-- Leaflet (mapas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body{font-family:system-ui,Segoe UI,Arial;max-width:1100px;margin:8px auto;padding:12px;}
  h1{margin:4px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 300px;min-width:260px}
  textarea{width:100%;min-height:120px}
  .thumb{width:120px;height:90px;object-fit:cover;border:1px solid #ddd}
  .file-row{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #eee}
  .controls{margin:8px 0}
  button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer}
  button.primary{background:#0b84ff;color:white;border:0}
  .grid-collage{border:1px dashed #bbb;padding:8px;display:inline-block;background:white}
  #collageCanvas{background:#fff;max-width:100%}
  .proposal{border:1px solid #eee;padding:8px;margin:6px 0;border-radius:6px;background:#fafafa}
  .smallmap{width:160px;height:120px;border:1px solid #ddd;cursor:pointer}
  .copy-btn{margin-left:8px;font-size:13px}
  .hidden{display:none}
  .top-help{font-size:14px;color:#555;margin-bottom:6px}
  .line-item{display:flex;gap:12px;align-items:flex-start;margin:6px 0;padding:6px;border:1px solid #eee;border-radius:6px}
  .meta-box{flex:1}
  .controls-row{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-block;padding:3px 6px;border-radius:12px;background:#eee;font-size:12px}
  /* Modal mapa grande */
  #mapModal{
    display:none;position:fixed;z-index:999;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.7);align-items:center;justify-content:center;
  }
  #mapLarge{
    width:90%;height:80%;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.5);
  }
</style>
</head>
<body>
  <h1>Collage + Wayfarer Helper (gratis)</h1>
  <div class="top-help">
    Flujo: 1) pega links p√∫blicos de Drive ‚Üí 2) selecciona fotos ‚Üí 3) generar collage (descarga PNG) ‚Üí 4) guarda ubicaciones desde el m√≥vil ‚Üí 5) pega mis propuestas (formato "Foto N") ‚Üí 6) copia r√°pido cada campo.
  </div>

  <!-- 1. Cargar enlaces de Drive -->
  <section>
    <h2>1) Pega enlaces de tus fotos (Drive)</h2>
    <textarea id="driveLinks" placeholder="https://drive.google.com/file/d/FILE_ID/view..."></textarea>
    <div class="controls">
      <button id="btnLoad">Cargar fotos</button>
      <button id="btnClear">Limpiar lista</button>
    </div>
    <div id="filesList"></div>
  </section>

  <hr/>

  <!-- 2. Seleccionar y generar collage -->
  <section>
    <h2>2) Selecciona fotos y genera collage numerado</h2>
    <div style="margin-bottom:6px">
      Fotos seleccionadas: <span id="selectedCount">0</span>
      <span style="margin-left:12px" class="badge">Tama√±o collage (cols): <input id="colsInput" type="number" value="3" min="1" max="6" style="width:54px"/></span>
      <span style="margin-left:8px" class="badge">Ancho por foto(px): <input id="wInput" type="number" value="300" min="80" max="1200" style="width:70px"/></span>
    </div>
    <div class="controls-row">
      <button id="btnGenerate" class="primary">Generar collage</button>
      <button id="btnDownload">Descargar collage (PNG)</button>
      <button id="btnClearSelection">Limpiar selecci√≥n</button>
    </div>
    <div style="margin-top:12px">
      <div class="grid-collage">
        <canvas id="collageCanvas"></canvas>
      </div>
      <div id="collagePreview"></div>
    </div>
  </section>

  <hr/>

  <!-- 3. Guardar ubicaciones -->
  <section>
    <h2>3) Guardar ubicaciones</h2>
    <div class="controls-row">
      <button id="btnSaveLocation" class="primary">Guardar ubicaci√≥n</button>
      <button id="btnExportLocations">Exportar ubicaciones (JSON)</button>
      <button id="btnImportLocations">Importar ubicaciones</button>
      <input id="locFile" type="file" accept="application/json" class="hidden"/>
    </div>
    <div id="locationsList"></div>
  </section>

  <!-- Modal mapa grande -->
  <div id="mapModal" onclick="closeMapModal()">
    <div id="mapLarge"></div>
  </div>

<script>
/* üîπ Link de Drive ‚Üí miniatura y directo */
function driveToDirect(linkOrId){
  if(!linkOrId) return null;
  linkOrId = linkOrId.trim();
  const m = linkOrId.match(/[-\w]{25,}/);
  if(m){
    const id = m[0];
    return {
      full: "https://drive.google.com/uc?id="+id,
      thumb: "https://drive.google.com/thumbnail?id="+id+"&sz=w200-h200"
    };
  }
  return null;
}

/* Estado */
let files = [];
let locations = [];
const el = id => document.getElementById(id);

el('btnLoad').addEventListener('click', ()=>{
  const lines = el('driveLinks').value.trim().split(/\r?\n/).filter(Boolean);
  files = [];
  lines.forEach(l=>{
    const obj = driveToDirect(l);
    if(obj) files.push({id:l, url:obj.full, thumb:obj.thumb, selected:false});
  });
  renderFiles();
});

function renderFiles(){
  const wrap = el('filesList'); wrap.innerHTML='';
  files.forEach(f=>{
    const div=document.createElement('div'); div.className='file-row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=f.selected;
    cb.onchange=e=>{f.selected=e.target.checked; updateSelectedCount();}
    const img=document.createElement('img'); img.className='thumb'; img.src=f.thumb;
    div.appendChild(cb); div.appendChild(img);
    wrap.appendChild(div);
  });
  updateSelectedCount();
}
function updateSelectedCount(){ el('selectedCount').innerText = files.filter(f=>f.selected).length; }

/* Collage */
el('btnGenerate').addEventListener('click', async ()=>{
  const selected = files.filter(f=>f.selected);
  if(!selected.length){alert("Selecciona fotos");return;}
  const cols=parseInt(el('colsInput').value)||3;
  const w=parseInt(el('wInput').value)||300, h=Math.round(w*0.75);
  const imgs=await Promise.all(selected.map(s=>loadImage(s.url).catch(()=>null)));
  const valid=imgs.filter(Boolean);
  const rows=Math.ceil(valid.length/cols);
  const canvas=el('collageCanvas'); canvas.width=cols*w+(cols+1)*8; canvas.height=rows*h+(rows+1)*8;
  const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  valid.forEach((img,i)=>{
    const r=Math.floor(i/cols), c=i%cols, x=8+c*(w+8), y=8+r*(h+8);
    const ratio=Math.max(w/img.width,h/img.height);
    const sw=w/ratio, sh=h/ratio, sx=(img.width-sw)/2, sy=(img.height-sh)/2;
    ctx.drawImage(img,sx,sy,sw,sh,x,y,w,h);
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(x+6,y+6,34,28);
    ctx.fillStyle='white'; ctx.font='18px sans-serif'; ctx.fillText(i+1,x+16,y+26);
  });
  // Mostrar miniatura del collage
  const dataUrl=canvas.toDataURL("image/png");
  el('collagePreview').innerHTML=`<img src="${dataUrl}" style="max-width:400px;border:1px solid #ccc;margin-top:8px">`;
});
function loadImage(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=rej;i.src=url;});}
el('btnDownload').addEventListener('click',()=>{const c=el('collageCanvas');if(!c.width){alert("Genera collage");return;}const a=document.createElement('a');a.href=c.toDataURL();a.download="collage.png";a.click();});

/* Ubicaciones + mapas ampliables */
el('btnSaveLocation').addEventListener('click',()=>{
  if(!navigator.geolocation){alert("No soportado");return;}
  const num=prompt("N√∫mero de foto:"); if(!num) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    locations.push({num,lat:pos.coords.latitude,lon:pos.coords.longitude});
    renderLocations();
  });
});
function renderLocations(){
  const wrap=el('locationsList'); wrap.innerHTML='';
  locations.forEach(loc=>{
    const div=document.createElement('div'); div.className='line-item';
    const mapDiv=document.createElement('div'); mapDiv.className='smallmap';
    div.appendChild(mapDiv); wrap.appendChild(div);
    setTimeout(()=>{
      const map=L.map(mapDiv,{zoomControl:false,attributionControl:false}).setView([loc.lat,loc.lon],17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      L.marker([loc.lat,loc.lon]).addTo(map);
      map.dragging.disable();map.scrollWheelZoom.disable();
      mapDiv.onclick=()=>openMapModal(loc);
    },50);
  });
}
function openMapModal(loc){
  document.getElementById("mapModal").style.display="flex";
  setTimeout(()=>{
    const map=L.map('mapLarge').setView([loc.lat,loc.lon],18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    L.marker([loc.lat,loc.lon]).addTo(map);
  },100);
}
function closeMapModal(){
  document.getElementById("mapModal").style.display="none";
  document.getElementById("mapLarge").innerHTML="";
}
</script>
</body>
</html>
